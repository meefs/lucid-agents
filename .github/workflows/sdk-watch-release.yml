name: SDK Watch & Release

on:
  repository_dispatch:
    types: [api-spec-updated]
  workflow_dispatch:
    inputs:
      openapi_url:
        description: 'OpenAPI spec URL (optional, uses default if not provided)'
        required: false
        type: string

concurrency:
  group: sdk-watch-release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  regenerate-and-release:
    name: Regenerate SDK & Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate SDK
        working-directory: packages/api-sdk
        env:
          OPENAPI_URL: ${{ inputs.openapi_url || 'https://api-lucid-dev.daydreams.systems/doc' }}
        run: bun run generate

      - name: Check for SDK changes
        id: check-changes
        working-directory: packages/api-sdk
        run: |
          if [ -n "$(git status --porcelain src/sdk/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create changeset
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Check if changeset already exists
          if ls .changeset/*api-sdk*.md 2>/dev/null; then
            echo "Changeset already exists, skipping creation"
          else
            TIMESTAMP=$(date +%s)
            cat > .changeset/api-sdk-update-${TIMESTAMP}.md << 'INNEREOF'
          ---
          "@lucid-agents/api-sdk": patch
          ---

          Updated SDK to match latest API specification
          INNEREOF
            echo "Created changeset: .changeset/api-sdk-update-${TIMESTAMP}.md"
          fi

      - name: Commit SDK changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add packages/api-sdk/src/sdk/ .changeset/
          git commit -m "chore(api-sdk): regenerate SDK from OpenAPI spec"
          git push

      - name: Trigger release workflow
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yml',
              ref: context.ref
            });
            console.log('âœ… Triggered release workflow');

      - name: No changes detected
        if: steps.check-changes.outputs.has_changes != 'true'
        run: |
          echo "::notice title=No Changes::SDK is already up to date with the API specification"
