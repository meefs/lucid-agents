name: Deploy (GCP)

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

concurrency:
  group: gcp-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ vars.BUN_VERSION || 'latest' }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ github.ref == 'refs/heads/main' && vars.GCP_PROJECT_PROD || vars.GCP_PROJECT_STAGING }}

      - name: Select deployment environment
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "TF_ENV=prod" >> "$GITHUB_ENV"
            echo "PROJECT_ID=${{ vars.GCP_PROJECT_PROD }}" >> "$GITHUB_ENV"
            echo "CLIENT_BUCKET=${{ vars.CLIENT_BUCKET_PROD }}" >> "$GITHUB_ENV"
            echo "CLIENT_PREFIX=prod" >> "$GITHUB_ENV"
            echo "STATE_BUCKET=${{ vars.STATE_BUCKET_PROD }}" >> "$GITHUB_ENV"
            echo "CLIENT_URL_MAP=${{ vars.CLIENT_URL_MAP_PROD }}" >> "$GITHUB_ENV"
            echo "CLOUD_RUN_FLAGS=${{ vars.CLOUD_RUN_FLAGS_PROD }}" >> "$GITHUB_ENV"
          else
            echo "TF_ENV=staging" >> "$GITHUB_ENV"
            echo "PROJECT_ID=${{ vars.GCP_PROJECT_STAGING }}" >> "$GITHUB_ENV"
            echo "CLIENT_BUCKET=${{ vars.CLIENT_BUCKET_STAGING }}" >> "$GITHUB_ENV"
            echo "CLIENT_PREFIX=staging" >> "$GITHUB_ENV"
            echo "STATE_BUCKET=${{ vars.STATE_BUCKET_STAGING }}" >> "$GITHUB_ENV"
            echo "CLIENT_URL_MAP=${{ vars.CLIENT_URL_MAP_STAGING }}" >> "$GITHUB_ENV"
            echo "CLOUD_RUN_FLAGS=${{ vars.CLOUD_RUN_FLAGS_STAGING }}" >> "$GITHUB_ENV"
          fi

          echo "REGION=${{ vars.GCP_REGION }}" >> "$GITHUB_ENV"
          if [[ -n "${{ vars.GCP_ARTIFACT_LOCATION }}" ]]; then
            echo "ARTIFACT_LOCATION=${{ vars.GCP_ARTIFACT_LOCATION }}" >> "$GITHUB_ENV"
          else
            echo "ARTIFACT_LOCATION=${{ vars.GCP_REGION }}" >> "$GITHUB_ENV"
          fi

          if [[ -z "${{ vars.CLOUD_RUN_API_NAME }}" ]]; then
            echo "::error ::CLOUD_RUN_API_NAME repository variable must be set." && exit 1
          fi
          echo "CLOUD_RUN_API_NAME=${{ vars.CLOUD_RUN_API_NAME }}" >> "$GITHUB_ENV"

          if [[ -z "${{ vars.GCP_REGION }}" ]]; then
            echo "::error ::GCP_REGION repository variable must be set." && exit 1
          fi

          if [[ -z "${{ vars.GCP_PROJECT_PROD }}" && "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "::error ::GCP_PROJECT_PROD repository variable must be set for main deployments." && exit 1
          fi

          if [[ -z "${{ vars.GCP_PROJECT_STAGING }}" && "${GITHUB_REF}" != "refs/heads/main" ]]; then
            echo "::error ::GCP_PROJECT_STAGING repository variable must be set for staging deployments." && exit 1
          fi

      - name: Ensure derived defaults
        run: |
          if [[ -z "${STATE_BUCKET}" ]]; then
            echo "STATE_BUCKET=${PROJECT_ID}-tfstate" >> "$GITHUB_ENV"
          fi

          if [[ -z "${CLIENT_BUCKET}" ]]; then
            echo "::error ::CLIENT_BUCKET repository variable must be set (CLIENT_BUCKET_PROD / CLIENT_BUCKET_STAGING)." && exit 1
          fi

          if [[ -z "${CLIENT_PREFIX}" ]]; then
            echo "CLIENT_PREFIX=${TF_ENV}" >> "$GITHUB_ENV"
          fi

      - name: Write Makefile environment
        run: |
          cat <<ENVVARS > .env.gcloud
          PROJECT_ID=${PROJECT_ID}
          REGION=${REGION}
          ARTIFACT_LOCATION=${ARTIFACT_LOCATION}
          STATE_BUCKET=${STATE_BUCKET}
          STATE_BUCKET_LOCATION=${REGION}
          TF_ENV=${TF_ENV}
          CLIENT_BUCKET=${CLIENT_BUCKET}
          CLIENT_PREFIX=${CLIENT_PREFIX}
          CLIENT_URL_MAP=${CLIENT_URL_MAP}
          CLOUD_RUN_API_NAME=${CLOUD_RUN_API_NAME}
          CLOUD_RUN_FLAGS=${CLOUD_RUN_FLAGS}
          ENVVARS

          echo "Generated .env.gcloud"
          cat .env.gcloud

      - name: Bootstrap project (idempotent)
        run: make bootstrap

      - name: Terraform init
        run: make tf-init

      - name: Terraform plan
        run: make tf-plan

      - name: Terraform apply
        run: make tf-apply

      - name: Build & deploy application
        run: make deploy

      - name: Show Terraform outputs
        run: terraform -chdir=deploy/terraform output
        continue-on-error: true
